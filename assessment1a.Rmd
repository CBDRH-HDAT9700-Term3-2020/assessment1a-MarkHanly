---
title: "HDAT9700: Assessment 1A - Chapters 1-3"
output: github_document
always_allow_html: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE) # Suppressing code, messages and warnings from printing

# Add libraries
library(ggplot2)
library(dplyr)
library(ggdag)
library(dagitty)
library(MatchIt)
library(knitr)
library(kableExtra)

# Set seed for reproducibility
set.seed(242487)

```

### Overview

In this assignment you are provided with observational data on maternal characteristics and birth outcomes. Your aim is to estimate the total causal effect of maternal smoking during pregnancy on birth weight.  

The data come from [Abrevaya (2006)](https://onlinelibrary.wiley.com/doi/abs/10.1002/jae.851) _Estimating the effect of smoking on birth outcomes using a matched panel data approach_. More details can be found [here](http://qed.econ.queensu.ca/jae/2006-v21.4/abrevaya/readme.ja.txt). The dataset has been restricted to mother's first birth and **for the purposes of this assignment can be treated as observational data generated through a simple random sample of births**. So the emphasis in this assignment is on drawing and understanding a DAG, implementing matching and correctly interpreting the results, you don't have to worry about sample corrections (e.g. weighting) or correcting for dependency in matched pairs. 

#### Here is a brief description of the available variables:                                         
* **momid** identification number of the mother                                    
* **idx** index number of a mother's birth                              
* **mage** age of mother (in years)                                               
* **gestat** length of gestation (in weeks)                                         
* **birwt** birth weight (in grams)
* **smoke** indicator variable for smoking status (1=smoker, 0=nonsmoker)
* **male** sex of the baby (1=male, 0=female)
* **collgrad** college-graduate indicator (1=graduate, 0=non-graduate)
* **black** indicator variable for black race (1=black, 0=white)

These data are contained in your assignment repo in the file `dt.rda`, which can be loaded as follows:

``` {r read-data}
# Load the data
load("dt.rda")
```

***
# Sample solution

## Question 1 solution

#### (1) Draw a DAG to represent the causal relationship between maternal smoking and birth weight. Write a brief descriptive paragraph that highlights any backdoor path(s) and the observed variables that might be useful to close the path(s). (25%)

_Hint: Not all variables that appear in the dataset need to be on your DAG and not all nodes that are on your DAG will necessarily be observed variables. You can draw your DAG using whatever tool you prefer. Options include `ggdag()` in R, [daggity.net](http://dagitty.net/dags.html), a screenshot from a DAG drawn in MS Word etc, or an embedded picture of a DAG drawn with pen and paper._


The DAG below represents my assumptions about the causal relationship between smoking during pregnancy and birth weight. The causal model implies that smoking affects birth weight directly (`smoking` &rarr; `birthweight`) and indirectly throught the mediating factor length of gestation (`smoking` &rarr; gestation &rarr; `birthweight`). 


```{r, echo = FALSE, fig.height = 7, fig.width = 12}
# I have used the tool at dagitty.net to draft my DAG and generate the code below, which I will pass to ggdag to present here. 

myDAG <- 'dag{
"antenatal care" [pos="-0.592,-1.105"]
"childhood SES" [pos="-2.133,-0.110"]
"maternal age" [pos="-0.747,1.253"]
birthweight [outcome,pos="1.285,-0.031"]
education [pos="-1.353,-1.017"]
gestation [pos="0.836,0.416"]
income [pos="-1.353,-0.259"]
nutrition [pos="-0.269,-0.435"]
smoking [exposure,pos="0.195,-0.091"]
stress [pos="-0.640,0.323"]
ethnicity [pos="-2.133,.700"]
sex [pos="1.285, .700"]
"antenatal care" -> birthweight
"antenatal care" -> nutrition
"antenatal care" -> smoking
"childhood SES" -> "maternal age"
"childhood SES" -> education
"childhood SES" -> income
"childhood SES" -> stress
"maternal age" -> birthweight
"maternal age" -> smoking
education -> "antenatal care"
education -> "maternal age"
education -> income
gestation -> birthweight
income -> "antenatal care"
income -> "maternal age"
income -> nutrition
income -> stress
nutrition -> birthweight
smoking -> birthweight
smoking -> gestation
stress -> birthweight
stress -> smoking
ethnicity -> "maternal age"
ethnicity -> income
ethnicity -> "childhood SES"
sex -> birthweight
}'

# Pass dagitty object to ggdag
ggdag(myDAG, text_col = "dark blue", node = FALSE) + theme_dag()

```

There are many background factors which I theorise will affect the likelihood of a mother smoking during pregnancy as well as the outcome of birth weight. The number of paths on a DAG grows exponentially with the number of nodes and edges and consequently there are a very large number of backdoor paths implied by this DAG (there are actually 416 backdoor paths!!). In the interests of brevity I won't enumerate them all here, but below are a subset of the shorter paths.

#### Examples of pathways with `maternal age` as a parent of smoking and birth weight
* smoking &larr; maternal age &rarr; birth weight 
* smoking &larr; maternal age &larr; childhood SES &rarr; stress &rarr; birth weight 
* smoking &larr; maternal age &larr; childhood SES &rarr; income &rarr; stress &rarr; birth weight
* smoking &larr; maternal age &larr; income &rarr; antenatal care &rarr; nutrition &rarr; birth weight 

#### Examples of pathways with `stress` as a parent of smoking and birth weight
* smoking &larr; stress &rarr; birth weight 
* smoking &larr; stress &larr; income &rarr; nutrition &rarr; birth weight 
* smoking &larr; stress &larr; income &larr; ethnicity &rarr; childhood SES &rarr; education &rarr; antenatal care &rarr; birth weight 

#### Examples of pathways with `antenatal care` as a parent of smoking and birth weight
* smoking &larr; antenatal care &rarr; birth weight 
* smoking &larr; antenatal care &rarr; nutrition &rarr; birth weight 


### Adjustment sets
Based on this DAG, the minimal adjustment set controlling for access to antenatal care, `maternal age` and experience of stress would be sufficient to close **all** of the backdoor paths. Controlling for these three variables, for example by matching, would be sufficient to satisfy the exchageability assumption and allow us to estimate the causal effect of maternal smoking on birth weight. Of these three variables, only maternal age is observed directly in the variable `mage`. The observed variable `collgrad` indicates whether mothers had a third level degree, and this can be used to help close pathways that include `education`. It is plausible that `collgrad` could also act as a proxy for `income`, which is not measured in the dataset. The variable `black` indicates that the mother was an African American women, and can be used to help close backdoor paths involving the variable `ethnicity`. Given the social context in which the data were collected, the variable `black` is likely to be correlated with `childhood SES`, `income` and `education` and therefore may also help to close backdoor paths involving those variable.  

I have assumed that smoking during pregnancy will influence the length of gestation which, in turn, will have an effect on birth weight. This means that we would expect to see an association between gestation and smoking status and between gestation and birth weight. However, because gestation is a mediator, i.e. it lies on a frontdoor path between smoking and birth weight, we do not need to control for gestation when estimating the total effect of smoking on birth weight.  

I have also assumed that birth weight will be influenced by sex of the baby, but do not think there is a link between smoking during pregnancy and sex of the baby. Therefore, it is not neccesary to control for sex when estimating the total effect of smoking on birth weight.

To review, the observed variables I will match on to help close the backdoor paths implied by my DAG are maternal age `mage`, graduation status `collgrad`, and African American status `black`. Note that some backdoor paths remain open, for example:

* smoking &larr; stress &rarr; birth weight 
* smoking &larr; antenatal care &rarr; birth weight 

***

## Question 2 solution

#### (2) Match smokers to non-smokers using a matching method of your choice and matching variables that are consistent with your DAG. Briefly summarise the balance in both cases, drawing on appropriate numerical and graphical summaries. (25%)

First, I will run some exploratory analyses to compare the background characteristics of the smoking and non-smoking groups. The table below uses the `compareGroups` package to summarise the observed variables by smoking status. 

```{r}
# Load compare groups library
library(compareGroups)

# Define table
tab <- compareGroups(smoke ~ mage + black + collgrad, 
                     data = dt,
                     method = c(1,3,3)
                     )

# print table
createTable(tab) 
```

In the observed data there are 561 smokers (14%) and 3,417 non-smokers (86%). We can see that there are some marked differences in the observed background characteristics comparing women who did and did not smoke during pregnancy. Smoking mums were younger on average (25.3 years versus 27.7 years), more likely to be black (9.8% versus 6.7%) and much less likely to have attended college (7.3% versus 40.6%). 

The figure below presents the number of smokers and non-smokers in each category of the three control variable groups. This figure highlights some sparceness in the data. For example, there are only `r dt %>% filter(black==1 & collgrad==1) %>% nrow()` African-American college graduates in the sample, and only `r dt %>% filter(black==1 & collgrad==1 & smoke==1) %>% nrow()` of these were smokers.

```{r}

# Plot the Number of smokers and non-smokers by categories of the matching variables
dt %>% group_by(smoke, mage, collgrad, black) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(y=count, x = mage, fill=as.factor(smoke))) + 
  geom_bar(stat = "identity") + 
  labs(x = "Maternal age", y = "Count", title = "Number of smokers and non-smokers by categories of the matching variables") +
  scale_fill_manual("Smoking status", label = c("Non-smoker", "Smoker"), values = c("hotpink", "lightblue")) + 
  theme_dark() +
  facet_wrap(~ black + collgrad, scales = 'free',
             labeller = labeller(
               black = c('0'='Not African-American', '1'='African-American'), 
               collgrad = c('0' = 'Not a college graduate', '1' = 'College graduate'))) 



```


However, it does look like there are potential exact matches for almost all mothers who smoked, for the limited matching variables available. As a result, I am going to proceed with **exact matching** smokers to non-smokers on `mage` `black` and `collgrad`.

The table below provides the matching summary from this exact match: out of 561 smokers and 3,417 non-smokers, we have matched 555 and 3,321 individuals respectively. 

```{r}
# Match on mage, black and collgrad using exact matching
match1 <- matchit(smoke ~ mage + black + collgrad, data = dt, method = 'exact')

# Store the summary object
sum <- summary(match1)  

# Print the table of numbers matched from the summary object
sum$nn %>% kbl()  %>%  kable_styling(bootstrap_options = c("hover", "striped"), full_width = FALSE)
```


We can visualise the proportion of respondents in each category of our three matching variables to confirm that smokers and non-smokers are perfectly balanced in the matched data.

```{r}
# Store the matched data
md <- match.data(match1)

# Plot the proportions of smokers and non-smokers to show the balance across the matched data
ggplot(data = md, aes(x = mage, weight = weights, fill=as.factor(smoke))) + # Remember to apply the weights!
  geom_bar(aes(y = (..prop..)), position = 'dodge') + 
  labs(x = "Maternal age", y = "Count", title = "Balance across the three matching categories in the matched data") +
  scale_fill_manual("Smoking status", label = c("Non-smoker", "Smoker"), values = c("hotpink", "lightblue")) + 
  theme_dark() +
  facet_wrap(~ black + collgrad, scales = 'free',
             labeller = labeller(
               black = c('0'='Not African-American', '1'='African-American'), 
               collgrad = c('0' = 'Not a college graduate', '1' = 'College graduate'))) 



```

As summarised below, in the weighted matched data, the smokers and non-smokers were perfectly matched with an average maternal age of 25 years, 9.7% black mothers and 7.2% college graduates.

#### Maternal age
```{r}
# Print the weighted mean of maternal age by smoking status
md %>% 
  mutate(mage_wt = mage*weights) %>%
  group_by(smoke) %>% 
  summarise(Mean = mean(mage_wt)) %>% 
  kbl() %>%  
  kable_styling(bootstrap_options = c("hover", "striped"), full_width = FALSE)
```

#### African-American status
```{r}
# Print the weighted mean of the black indicator by smoking status
md %>% 
  mutate(black_wt = black*weights) %>%
  group_by(smoke) %>% 
  summarise(Mean = mean(black_wt)) %>% 
  kbl() %>%  
  kable_styling(bootstrap_options = c("hover", "striped"), full_width = FALSE)
```

#### College graduate
```{r}
# Print the weighted mean of the collgrad indicator by smoking status
md %>% 
  mutate(collgrad_wt = collgrad*weights) %>%
  group_by(smoke) %>% 
  summarise(Mean = mean(collgrad_wt)) %>% 
  kbl() %>%  
  kable_styling(bootstrap_options = c("hover", "striped"), full_width = FALSE)
```

***

## Question 3 solution

#### (3) Fit the model birwt ~ smoke in (i) The raw data and (ii) the matched data. Briefly describe the model results. How does the estimated effect for smoking change and why? (25%)

The estimated models are presented below. In the unmatched data, the estimated effect of smoking during pregnancy on birth weight is -290g (95% CI = -334g, -245g), i.e. babies of mothers who smoked were 290g lighter on average. In the weighted matched data the estimated effect of smoking during pregnancy on birth weight is -258g (95% CI = -303g, -213g), i.e. babies of mothers who smoked were 258g lighter on average. 

```{r}
# Fit the model in the unmatched data
mod1 <- lm(birwt ~ smoke, data = dt)

# Fit the model in the matched data
mod2 <- lm(birwt ~ smoke, data = md, weights = weights) ## Remember ot apply the weights!

# Load the sjPlot library
library(sjPlot)

# Use tab_model to compare the model parameter estimates
tab_model(mod1, mod2, digits = 0, 
          dv.labels = c("Unmatched data", "Weighted matched data"), 
          title = "Point estimates and 95% CIs for regression models of smoking on birth weight",
          show.r2 = FALSE)
```

The magnitude of the estimated effect of smoking is less in the matched data compared to the unmatched data. The reason that the estimated effect decreases is because in the matched data we have balanced maternal age, and the proportion of Black and college-educated mothers in the smoking and non-smoking groups. These factors confound the effect of smoking on birth weight. By balancing these variables we have removed their confounding effect and gotten closer to the true causal effect of smoking on birth weight.

***

## Question 4 Solution
#### (4) Briefly discuss any limitations of the model 3(ii) and argue whether or not the assumption of exchangeability is likely to hold. (25%)

In order to interpret the estimate of -258 (-303, -213) as the causal effect of smoking on birth weight rather than a measure of the association between smoking and birth weight, we must assume that the three identifiability assumptions hold for our analysis. The identifiability assumptions are:

1. Positivity 
2. Exchangeability 
3. Consistency 

We can consider the limitations of our model **3(ii)** with respect to these 3 assumptions. **Positivity** assumes that the probability of being a smoker and a non-smoker is positive in every category of the control variables. We saw that smokers and non-smokers were not present in all categories, particularly for Black college graduates. This limits the generalisability of our assumptions, but we could argue that the effects of smoking are likely to be the same among Black college graduates as among the other groups.

**Consistency** means that everybody should get the same version of treatment. In our case, we do not know the number of cigarettes smoked per day, how long the mother has been smoking or if they gave up smoking at any point during their pregnancy. This is a major limitation because we really don't have a consistent definition of what it means to smoke during pregnancy.  

**Exchangeability** means that smokers and non-smokers should be balanced in terms of all of the background characteristics that affect the likelihood of smoking during pregnancy and birth weight. The DAG above presents several such factors which we were unable to control for, including levels of stress and access to antenatal care. Accordingly, it is unlikely that the assumption of exchangeability hold here. Unsurprisingly, we can't really be confident in interpreting the estimates from such a simple model as casual effects. 

***



